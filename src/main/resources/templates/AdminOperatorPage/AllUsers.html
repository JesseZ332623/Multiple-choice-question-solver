<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨</title>
</head>
<style>
    :root {
        --gh-bg: #0D1117;
        --gh-border: #30363D;
        --gh-text: #C9D1D9;
        --gh-primary: #58A6FF;
        --gh-success: #238636;
        --gh-danger: #DA3633;
        --gh-btn-hover: rgba(240, 246, 252, 0.1);
    }

    body {
        background-color: var(--gh-bg);
        color: var(--gh-text);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        padding: 20px;
        margin: 0;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid var(--gh-border);
        border-radius: 6px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        animation: fadeIn 0.3s ease-in;
    }

    caption {
        font-size: 16px;
        font-weight: 600;
        padding: 12px;
        background-color: #161B22;
        border-bottom: 1px solid var(--gh-border);
    }

    th, td {
        padding: 8px 12px;
        font-size: 14px;
        line-height: 1.5;
        text-align: left;
        border-bottom: 1px solid var(--gh-border);
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    th {
        background-color: #161B22;
        font-weight: 600;
    }

    tr:last-child td {
        border-bottom: none;
    }

    button {
        background-color: #21262D;
        color: var(--gh-text);
        border: 1px solid var(--gh-border);
        padding: 5px 12px;
        border-radius: 6px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
        margin: 2px;
    }

    button:hover {
        background-color: var(--gh-btn-hover);
        border-color: #8B949E;
        transform: scale(1.05);
    }

    button[onclick="doModify(this)"] {
        color: var(--gh-primary);
        border-color: var(--gh-primary);
    }

    button[onclick="doDelete(this)"] {
        color: var(--gh-danger);
        border-color: var(--gh-danger);
    }

    input {
        background-color: #0D1117;
        border: 1px solid var(--gh-border);
        color: var(--gh-text);
        padding: 5px 8px;
        border-radius: 4px;
        width: 90%;
        font-size: 13px;
        transition: border-color 0.2s ease;
    }

    input:focus {
        outline: none;
        border-color: var(--gh-primary);
        box-shadow: 0 0 0 3px rgba(17, 88, 199, 0.3);
    }

    #add_new_user_table_row td {
        padding: 8px 12px;
        background: #161b22;
    }
    
    #add_new_user_table_row input,
    #add_new_user_table_row select {
        width: 100%;
        box-sizing: border-box;
        background: #0d1117;
        border: 1px solid #30363d;
        color: #c9d1d9;
        padding: 6px;
    }
    
    #add_new_user_table_row select {
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%238B949E'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 8px center;
        background-size: 16px;
    }

    .action-row td {
        padding: 12px !important;
        background: #161b22 !important;
        border-top: 2px solid var(--gh-border);
    }
    
    .action-group {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: center;
        justify-content: space-between;
    }
    
    .button-group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .range-delete-group {
        display: flex;
        gap: 8px;
        flex-grow: 1;
        max-width: 400px;
    }
    
    .input-group {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-grow: 1;
    }
    
    .input-group input {
        width: 120px;
        flex-grow: 1;
        padding: 6px 8px;
    }
    
    .separator {
        color: var(--gh-text);
        padding: 0 4px;
    }
    
    /* æŒ‰é’®æ‰©å±•æ ·å¼ */
    .btn-success {
        color: var(--gh-success) !important;
        border-color: var(--gh-success) !important;
    }
    
    .btn-danger {
        color: var(--gh-danger) !important;
        border-color: var(--gh-danger) !important;
    }
    
    .btn-warning {
        color: #d29922 !important;
        border-color: #d29922 !important;
    }
    

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 768px) {
        table {
            display: block;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        th, td {
            min-width: 120px;
        }
        
        button {
            padding: 4px 8px;
            margin: 2px 0;
            display: block;
            width: 100%;
        }

        .action-group {
            flex-direction: column;
            align-items: stretch;
        }
        
        .range-delete-group {
            max-width: none;
        }
        
        .input-group input {
            width: 100%;
        }
    }

    @media (max-width: 480px) {
        body {
            padding: 10px;
        }
        
        table {
            border: 0;
        }
        
        thead {
            display: none;
        }
        
        tr {
            display: block;
            margin-bottom: 15px;
            border: 1px solid var(--gh-border);
            border-radius: 6px;
        }
        
        td {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            border: none;
            max-width: none;
            white-space: normal;
        }
        
        td::before {
            content: attr(data-label);
            font-weight: 600;
            margin-right: 10px;
            color: var(--gh-primary);
        }

        .button-group {
            flex-direction: column;
        }
        
        .button-group button {
            width: 100%;
        }
        
        .range-delete-group form {
            flex-direction: column;
        }
        
        .input-group {
            width: 100%;
        }
    }
</style>
<body>
    <div th:if="${#lists.size(AllUsers) != 0}">
        <table>
            <caption 
            th:text="'æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨ï¼ˆå…± ' + ${#lists.size(AllUsers)} + ' ä½ç”¨æˆ·)'">
            </caption>
            <thead>
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">ç”¨æˆ·å</th>
                    <th scope="col">å¯†ç ï¼ˆå¯†æ–‡å‰ 16 ä½ï¼‰</th>
                    <th scope="col">å…¨å</th>
                    <th scope="col">ç”µè¯å·ç </th>
                    <th scope="col">é‚®ç®±</th>
                    <th scope="col">æ³¨å†Œæ—¥æœŸ</th>
                    <th scope="col">è§’è‰²</th>
                    <th scope="col">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="user : ${AllUsers}">
                    <th data-label="ID" scope="row" th:text="${user.id}" th:id="'user_id_' + ${user.id}"></th>
                    <td data-label="ç”¨æˆ·å" th:text="${user.userName}" th:id="'username_' + ${user.id}"></td>
                    <td data-label="å¯†ç " th:text="${user.password}" th:id="'password_' + ${user.id}"></td>
                    <td data-label="å…¨å" th:text="${user.fullName}" th:id="'fullName_' + ${user.id}"></td>
                    <td data-label="ç”µè¯å·ç " th:text="${user.telephoneNumber}" th:id="'telephoneNumber_' + ${user.id}"></td>
                    <td data-label="é‚®ç®±" th:text="${user.email}" th:id="'email_' + ${user.id}"></td>
                    <td data-label="æ³¨å†Œæ—¥æœŸ" th:text="${user.registerDateTime}" th:id="'registerDateTime_' + ${user.id}"></td>
                    <td data-label="è§’è‰²" th:text="${user.roles}" th:id="'roles_' + ${user.id}"></td>
                    <td data-label="æ“ä½œ" th:id="'operator_' + ${user.id}">
                        <button type="button" data-click-count="0" onclick="doModify(this)">âœï¸ ä¿®æ”¹</button>
                        <button type="button" onclick="doDelete(this)">ğŸ—‘ï¸ åˆ é™¤</button>
                    </td>
                </tr>
                <tr id="add_new_user_table_row"></tr>
                <tr class="action-row">
                    <td colspan="9">  <!-- æ ¹æ®å®é™…åˆ—æ•°è°ƒæ•´colspan -->
                        <div class="action-group">
                            <!-- æ·»åŠ /åˆ é™¤æŒ‰é’®ç»„ -->
                            <div class="button-group">
                                <button type="button" 
                                    data-click-count="0" 
                                    onclick="doAddNewOne(this)"
                                    class="btn-success">
                                    â• æ–°å»ºç”¨æˆ·
                                </button> 
                                <button type="button" 
                                    onclick="doDeleteAll(this)"
                                    class="btn-danger">
                                    ğŸ—‘ï¸ å…¨éƒ¨åˆ é™¤
                                </button>
                            </div>

                            <!-- æ‰¹é‡åˆ é™¤è¡¨å• -->
                            <div class="range-delete-group">
                                <form id="delete_by_range">
                                    <div class="input-group">
                                        <input type="number" 
                                            id="delete_begin_id" 
                                            placeholder="èµ·å§‹ID"
                                            min="1">
                                        <span class="separator">-</span>
                                        <input type="number" 
                                            id="delete_end_id" 
                                            placeholder="ç»“æŸID"
                                            min="1">
                                    </div>
                                    <button type="button" 
                                        onclick="doDeleteByRange(this)"
                                        class="btn-warning">
                                        ï¼ˆRange ğŸ—‘ï¸ï¼‰æ‰¹é‡åˆ é™¤
                                    </button>
                                </form>
                            </div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div th:if="${#lists.size(AllUsers) == 0}">
        <h2>ç›®å‰æ²¡æœ‰ç”¨æˆ·ï¼Œä»¥ä¸‹æ“ä½œè¿›è¡Œæ·»åŠ ï¼š</h2>
        <table>
            <tbody>
                <tr id="add_new_user_table_row"></tr>
                <tr>
                    <td>
                        <button type="submit" 
                        data-click-count="0" onclick="doAddNewOne(this)">
                            â•
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</body>
<script>
    var DONOTIFY_OLD_USERNAME;

    const USER_ROLES  = {"roleId" : 2, "roleName" : "ROLE_USER"};
    const ADMIN_ROLES = {"roleId" : 1, "roleName" : "ROLE_ADMIN"};

    function createUserRolesJson(newRolesText)
    {
        let newRoles;
        
        if (newRolesText === "ROLE_USER") {
            newRoles = [USER_ROLES];
        }
        else if (newRolesText === "ROLE_ADMIN") {
            newRoles = [ADMIN_ROLES];
        }
        else if (
            newRolesText === "ROLE_USER ROLE_ADMIN" ||
            newRolesText === "ROLE_ADMIN ROLE_USER"
        ) {
            newRoles = [USER_ROLES, ADMIN_ROLES];
        }
        else {
            newRoles = [USER_ROLES];
        }

        return newRoles;
    }

    async function doModify(button) 
    {
        button.addEventListener(
            "click", 
            async function () 
            {
                // å‘ä¸ŠæŸ¥æ‰¾ç¦» button æœ€è¿‘çš„çˆ¶çº§ tr æ ‡ç­¾
                const tableRowElement = button.closest('tr');

                // å†ä»è¯¥ tr æ ‡ç­¾å¼€å§‹å‘ä¸‹æŸ¥æ‰¾æ‰€æœ‰çš„å­çº§ th å’Œ td æ ‡ç­¾ï¼Œè¿”å›ä¸€ä¸ª NodeList
                const cells = tableRowElement.querySelectorAll('td');

                let count = parseInt(this.dataset.clockCount) || 0;
                ++count;
                this.dataset.clockCount = count;

                switch (count)
                {
                    case 1:
                        cells.forEach((cell, index) => 
                        {
                            switch (index)
                            {
                                case 0:
                                    DONOTIFY_OLD_USERNAME = cell.textContent;
                                    cell.innerHTML 
                                    = `<input type="text" id="cell_${index}" placeholder=${cell.textContent}></input>`;
                                    break;
                                
                                case 5:
                                    cell.innerHTML 
                                        = `<input type="text" 
                                            id="cell_${index}"
                                            placeholder="${cell.textContent} (READ-ONLY)" readonly>
                                          </input>`;
                                    break;

                                case 6:
                                    cell.innerHTML
                                          = `<select id="cell_${index}">
                                                <option value="ROLE_USER">æ™®é€šç”¨æˆ·</option>
                                                <option value="ROLE_ADMIN">ç®¡ç†å‘˜</option>
                                                <option value="ROLE_ADMIN ROLE_USER">ç®¡ç†å‘˜ + æ™®é€šç”¨æˆ·</option>
                                            </select>`;
                                
                                case 7:
                                    break;
                                
                                default:
                                    cell.innerHTML 
                                    = `<input type="text" id="cell_${index}" placeholder=${cell.textContent}></input>`;
                                    break;
                            }
                        });

                        button.innerText = "æäº¤ä¿®æ”¹";

                        break;
                    
                    case 2:
                        let newUserName         = document.getElementById('cell_0').value;
                        let newPassword         = document.getElementById('cell_1').value;
                        let newFullName         = document.getElementById('cell_2').value;
                        let newTelephoneNumber  = document.getElementById('cell_3').value;
                        let newEmail            = document.getElementById('cell_4').value;
                        let newRolesText        = document.getElementById('cell_6').value;
                        let newRoles            = createUserRolesJson(newRolesText);
                
                        const submitData = 
                        {
                            "oldUserName" : DONOTIFY_OLD_USERNAME, 
                            "newUserName" : newUserName, 
                            "newPassword" : newPassword,
                            "newFullName" : newFullName,
                            "newTelephoneNumber" : newTelephoneNumber, 
                            "newEmail" : newEmail,
                            "newRoles" : newRoles
                        };

                        const submitDataJson = JSON.stringify(submitData);
                
                        console.info(submitDataJson);
                        
                        try 
                        {
                            // ä» meta æ ‡ç­¾è·å– CSRF Token
                            const csrfToken  = document.querySelector('meta[name="_csrf"]').content;
                            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
                            // fetch æ“ä½œ....
                            const response = await fetch(
                                '/api/admin/modify_user',
                                {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type' : 'application/json',
                                        [csrfHeader]: csrfToken
                                    },
                                    body: submitDataJson
                                }
                            );

                            if (!response.ok) 
                            {
                                const errorDetail = await response.text().catch(() => null);

                                throw new Error(
                                    `Http error! statues: ${response.status}. 
                                    Detail: ${errorDetail || 'Unknown'}`
                                );
                            }
                            else 
                            {
                                const successText = await response.text().catch(() => null);
                                alert(successText);
                            }

                        }
                        catch(error) 
                        {
                            console.error(error);
                            alert(error);
                        }

                        location.reload();
                        this.dataset.clockCount = 0;

                        break;
                }
            }
        );
    }
    async function doDelete(button) 
    {
        // å‘ä¸ŠæŸ¥æ‰¾ç¦» button æœ€è¿‘çš„çˆ¶çº§ tr æ ‡ç­¾
        const tableRowElement = button.closest('tr');

        const cells = tableRowElement.querySelectorAll('td');

        let deleteUserName;

        cells.forEach((cell, index) => 
        {
                switch(index) 
                {
                    case 0:
                        deleteUserName = cell.textContent;
                        break;

                    default:
                        break;
                }
        });

        console.info(deleteUserName);

        if (confirm(`ç¡®å®šåˆ é™¤ç”¨æˆ·: ${deleteUserName} å—ï¼Ÿ`)) 
        {
            // ä» meta æ ‡ç­¾è·å– CSRF Token
            const csrfToken  = document.querySelector('meta[name="_csrf"]').content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

            try 
            {
                const response = await fetch(
                    `/api/admin/delete/${deleteUserName}`,
                    {
                        method: 'DELETE',
                        headers: {
                            'Content-Type' : 'application/json',
                            [csrfHeader]: csrfToken
                        },
                        body: deleteUserName
                    }
                );

                if (!response.ok) 
                {
                    const errorDetail = await response.text().catch(() => null);

                    throw new Error(
                                    `Http error! statues: ${response.status}.
                                    Detail: ${errorDetail || 'Unknown'}`
                    );
                }
                else 
                {
                    const successDetail = await response.text().catch(() => null);
                    alert(successDetail);
                    location.reload();
                }

            }   
            catch(error) {
                console.error(error);
                alert(error);
            }
        }
    }

    async function doAddNewOne(button) 
    {
        button.addEventListener(
            "click",
            async function() 
            {
                const addNewUserRowElement
                    = document.getElementById('add_new_user_table_row');

                let count = parseInt(this.dataset.clockCount) || 0;
                ++count;
                this.dataset.clockCount = count;

                switch(count) 
                {
                    case 1:
                        addNewUserRowElement.innerHTML 
                            = `
                                <td data-label="ID"><input type="text" placeholder="ç”¨æˆ· IDï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰" readonly></input></td>

                                <td data-label="ç”¨æˆ·å"><input type="text" id="new_username" placeholder="æ–°ç”¨æˆ·å"></input></td>

                                <td data-label="å¯†ç "><input type="password" id="new_password" placeholder="å¯†ç "></input></td>

                                <td data-label="å…¨å"><input type="text" id="new_fullname" placeholder="ç”¨æˆ·å…¨å"></input></td>

                                <td data-label="ç”µè¯å·ç "><input type="tel" id="new_telephone" placeholder="ç”µè¯å·ç ï¼ˆ+86ï¼‰"></input></td>

                                <td data-label="é‚®ç®±"><input type="email" id="new_email" placeholder="é‚®ç®±"></input></td>
                                
                                <td data-label="æ³¨å†Œæ—¥æœŸ"><input type="text" id="new_register_date" placeholder="æ³¨å†Œæ—¶é—´ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰" readonly></input></td>

                                <td data-label="è§’è‰²"> 
                                    <select id="new_roles">
                                        <option value="ROLE_USER">æ™®é€šç”¨æˆ·</option>
                                        <option value="ROLE_ADMIN">ç®¡ç†å‘˜</option>
                                        <option value="ROLE_ADMIN ROLE_USER">ç®¡ç†å‘˜ + æ™®é€šç”¨æˆ·</option>
                                    </select>
                                </td>
                            `;
                        
                        button.innerText = 'â• åˆ›å»ºæ–°ç”¨æˆ·';

                        break;
                    
                    case 2:
                        const submitData = {
                            userName        : document.getElementById('new_username').value,
                            password        : document.getElementById('new_password').value,
                            fullName        : document.getElementById('new_fullname').value,
                            telephoneNumber : document.getElementById('new_telephone').value,
                            email           : document.getElementById('new_email').value,
                            roles           : createUserRolesJson(document.getElementById('new_roles').value)
                        };

                        const submitDataJson = JSON.stringify(submitData);

                        console.info(submitDataJson);
                        
                        try 
                        {
                            // ä» meta æ ‡ç­¾è·å– CSRF Token
                            const csrfToken  = document.querySelector('meta[name="_csrf"]').content;
                            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                            const response = await fetch(
                                '/api/admin/add_new_user',
                                {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type' : 'application/json',
                                        [csrfHeader]   : csrfToken
                                    },
                                    body: submitDataJson
                                }
                            );

                            if (!response.ok) 
                            {
                                const errorDetail = await response.text().catch(() => null);

                                throw new Error(
                                    `Http error! statues: ${response.status}. 
                                    Detail: ${errorDetail || 'Unknown'}`
                                );
                            }
                            else 
                            {
                                const successDetail = await response.text().catch(() => null);
                                alert(successDetail);
                                location.reload();
                                this.dataset.clockCount = 0;
                            }
                        }
                        catch(error) {
                            console.error(error);
                            alert(error)
                        }
                        break;
                    
                    default:
                        break;
                }
            }
        );
    }

    async function doDeleteAll(button) 
    {
        button.innerText = 'å¤„ç†ä¸­...';
        button.disabled  = true;

        try 
        {
            if (confirm('è¿™æ˜¯ä¸€ä¸ªæ•æ„Ÿæ“ä½œï¼Œç¡®å®šè¦åˆ é™¤æ‰€æœ‰ç”¨æˆ·å—ï¼Ÿ')) 
            {
                // ä» meta æ ‡ç­¾è·å– CSRF Token
                const csrfToken  = document.querySelector('meta[name="_csrf"]').content;
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                const response = await fetch(
                    '/api/admin/delete/all',
                    {
                        method: 'DELETE',
                        headers: { 
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        }
                    }
                );

                if (!response.ok) 
                {
                    throw new Error(
                        `Http error: ${response.status}, 
                        Detail: ${await response.text().catch(() => null) || 'Unknow'}`
                    );
                }
                else
                {
                    alert(`${await response.text().catch(() => null)}`);
                }
            }
        }
        catch(error) 
        {
            alert(error);
            console.error(error);
        }
        finally 
        {
            button.innerText = 'ALL ğŸ—‘ï¸';
            button.disabled  = false;
            location.reload();
        }
    }

    async function doDeleteByRange(button)
    {
        const beginInput = document.getElementById('delete_begin_id');
        const endInput   = document.getElementById('delete_end_id');

        if (beginInput.value <= 0 || endInput.value <= 0) 
        {
            alert('id èŒƒå›´ä¸å¾—å°äº 0ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚');
            beginInput.value = '';
            endInput.value   = '';

            return;
        }

        button.innerText = 'å¤„ç†ä¸­...';
        button.disabled  = true;

        try 
        {
            // ä» meta æ ‡ç­¾è·å– CSRF Token
            const csrfToken  = document.querySelector('meta[name="_csrf"]').content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

            const response = await fetch(
                `/api/admin/delete/range/${beginInput.value}_${endInput.value}`,
                {
                    method: 'DELETE',
                    headers: {
                        [csrfHeader] : csrfToken
                    }
                }
            );

            if (!response.ok) 
            {
                throw new Error(
                    `Http error: ${response.status}, 
                    Detail: ${await response.text().catch(() => null) || 'Unknow'}`
                );
            }
            else
            {
                alert(`${await response.text().catch(() => null)}`);
            }
        }
        catch(error) 
        {
            alert(error);
            console.error(error);
        }
        finally 
        {
            button.innerText = 'ï¼ˆRange ğŸ—‘ï¸ï¼‰æ‰¹é‡åˆ é™¤';
            button.disabled = true;
            location.reload();
        }
    }
</script>
</html>