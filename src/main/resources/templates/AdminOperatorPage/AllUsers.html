<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>所有用户列表</title>
</head>
<style>
:root {
  --gh-bg-color: #0d1117;
  --gh-border-color: #30363d;
  --gh-text-color: #c9d1d9;
  --gh-header-bg: #161b22;
  --gh-button-bg: #21262d;
  --gh-button-hover: #30363d;
  --gh-accent-blue: #1f6feb;
  --gh-accent-red: #d41310;
  --gh-accent-green: #01911e;
}

body {
  background-color: var(--gh-bg-color);
  color: var(--gh-text-color);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
  line-height: 1.5;
  padding: 20px;
  max-width: 1780px;
  margin: 0 auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  border: 1px solid var(--gh-border-color);
  border-radius: 8px;
  overflow: scroll;
  margin: auto;
  background-color: var(--gh-header-bg);
}

caption {
  text-align: center;
  padding: 12px;
  font-weight: 600;
  background-color: var(--gh-header-bg);
  border-bottom: 1.5px solid var(--gh-border-color);
}

th, td {
  padding: 14px 12px;
  text-align: center;
  border: 1px solid var(--gh-border-color);
  position: relative;
}

/* 为每个单元格添加微妙的投影 */
th:not(:first-child),
td:not(:first-child) {
  box-shadow: inset 1px 0 0 var(--gh-border-color);
}

th {
  background-color: var(--gh-header-bg);
  font-weight: 480;
  font-size: 14px;
}

tr:hover {
  background-color: rgba(110, 118, 129, 0.1);
}

button {
  background-color: var(--gh-button-bg);
  color: var(--gh-text-color);
  border: 1px solid var(--gh-border-color);
  border-radius: 6px;
  padding: 6px 12px;
  margin: 2px;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.3, 0, 0.5, 1);
  font-family: inherit;
}

button:hover {
  background-color: var(--gh-button-hover);
  border-color: #8b949e;
  transition-duration: 0.1s;
}

.btn-success {
  background-color: var(--gh-accent-green);
  border-color: #2ea043;
}

.btn-danger {
  background-color: var(--gh-accent-red);
  border-color: #f85149;
}

.btn-warning {
  background-color: #b88010;
  border-color: #c08714;
}

input, select {
  background-color: var(--gh-header-bg);
  border: 1px solid var(--gh-border-color);
  border-radius: 6px;
  color: var(--gh-text-color);
  padding: 6px 12px;
  width: 100%;
  box-sizing: border-box;
}

input:focus, select:focus {
  outline: none;
  border-color: var(--gh-accent-blue);
  box-shadow: 0 0 0 3px rgba(31, 111, 235, 0.3);
}

.input-group {
  display: flex;
  gap: 8px;
  align-items: center;
}

.input-group input {
  flex: 1;
  max-width: 120px;
}

.action-group {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
}

.button-group {
  display: flex;
  gap: 8px;
}

.gh-button {
  background-color: rgba(31, 111, 235, 0.1);
  border: 1px solid rgba(31, 111, 235, 0.4);
}

.gh-button:hover {
  background-color: rgba(31, 111, 235, 0.2);
}

#upload-status {
  font-size: 0.85em;
  margin-top: 4px;
}

img {
  vertical-align: middle;
  background-color: var(--gh-header-bg);
  border: 1px solid var(--gh-border-color);
}

@media (max-width: 768px) 
{
    table {
        border-spacing: 0 6px; /* 移动端减少垂直间距 */
    }

    td, th {
        padding: 12px 10px;
        font-size: 0.9em;
    }
    
    button {
        padding: 4px 8px;
        font-size: 0.9em;
    }
}

::placeholder {
  color: #6e7681;
  opacity: 1;
}
</style>
<body>
    <div th:if="${#lists.size(AllUsers) != 0}">
        <table>
            <caption 
            th:text="'所有用户列表（共 ' + ${#lists.size(AllUsers)} + ' 位用户)'">
            </caption>
            <thead>
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">用户名</th>
                    <th scope="col">头像</th>
                    <th scope="col">密码（密文前 16 位）</th>
                    <th scope="col">全名</th>
                    <th scope="col">电话号码</th>
                    <th scope="col">邮箱</th>
                    <th scope="col">注册日期</th>
                    <th scope="col">角色</th>
                    <th scope="col">操作</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="user : ${AllUsers}">
                    <th data-label="ID" scope="row" th:text="${user.id}" th:id="'user_id_' + ${user.id}"></th>

                    <!-- [0] -->
                    <td data-label="用户名" th:text="${user.userName}" th:id="'username_' + ${user.id}"></td>

                    <!-- [1] -->
                    <td data-label="头像">
                        <img th:src="@{'/api/user_info/user_overview_avatar/' + ${user.userName}}"
                             alt="头像"  style="width: 25px; height: 25px; border-radius: 50%;">
                    </td>

                    <!-- [2] -->
                    <td data-label="密码" th:text="${user.password}" th:id="'password_' + ${user.id}"></td>

                    <!-- [3] -->
                    <td data-label="全名" th:text="${user.fullName}" th:id="'fullName_' + ${user.id}"></td>

                    <!-- [4] -->
                    <td data-label="电话号码" th:text="${user.telephoneNumber}" th:id="'telephoneNumber_' + ${user.id}"></td>

                    <!-- [5] -->
                    <td data-label="邮箱" th:text="${user.email}" th:id="'email_' + ${user.id}"></td>

                    <!-- [6] -->
                    <td data-label="注册日期" th:text="${user.registerDateTime}" th:id="'registerDateTime_' + ${user.id}"></td>

                    <!-- [7] -->
                    <td data-label="角色" th:text="${user.roles}" th:id="'roles_' + ${user.id}"></td>

                    <!-- [8] -->
                    <td data-label="操作" th:id="'operator_' + ${user.id}">
                        <button type="button" data-click-count="0" onclick="doModify(this)">✍️ 修改</button>
                        <button type="button" onclick="doDelete(this)">🗑️ 删除</button>
                    </td>
                </tr>
                <tr id="add_new_user_table_row"></tr>
                <tr class="action-row">
                    <td colspan="9">  <!-- 根据实际列数调整colspan -->
                        <div class="action-group">
                            <!-- 添加/删除按钮组 -->
                            <div class="button-group">
                                <button type="button" 
                                    data-click-count="0" 
                                    onclick="doAddNewOne(this)"
                                    class="btn-success">
                                    ➕ 新建用户
                                </button> 
                                <button type="button" 
                                    onclick="doDeleteAll(this)"
                                    class="btn-danger">
                                    🗑️ 全部删除
                                </button>
                            </div>

                            <!-- 批量删除表单 -->
                            <div class="range-delete-group">
                                <form id="delete_by_range">
                                    <div class="input-group">
                                        <input type="number" 
                                            id="delete_begin_id" 
                                            placeholder="起始ID"
                                            min="1">
                                        <span class="separator">-</span>
                                        <input type="number" 
                                            id="delete_end_id" 
                                            placeholder="结束ID"
                                            min="1">
                                    </div>
                                    <button type="button" 
                                        onclick="doDeleteByRange(this)"
                                        class="btn-warning">
                                        （Range 🗑️）批量删除
                                    </button>
                                </form>
                            </div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div th:if="${#lists.size(AllUsers) == 0}">
        <h2>目前没有用户，以下操作进行添加：</h2>
        <table>
            <tbody>
                <tr id="add_new_user_table_row"></tr>
                <tr>
                    <td>
                        <button type="submit" 
                        data-click-count="0" onclick="doAddNewOne(this)">
                            ➕
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</body>
<script>

    const USER_ROLES  = {"roleId" : 2, "roleName" : "ROLE_USER"};
    const ADMIN_ROLES = {"roleId" : 1, "roleName" : "ROLE_ADMIN"};

    function createUserRolesJson(newRolesText)
    {
        let newRoles;
        
        if (newRolesText === "ROLE_USER") {
            newRoles = [USER_ROLES];
        }
        else if (newRolesText === "ROLE_ADMIN") {
            newRoles = [ADMIN_ROLES];
        }
        else if (
            newRolesText === "ROLE_USER ROLE_ADMIN" ||
            newRolesText === "ROLE_ADMIN ROLE_USER"
        ) {
            newRoles = [USER_ROLES, ADMIN_ROLES];
        }
        else {
            newRoles = [USER_ROLES];
        }

        return newRoles;
    }

    /*
        进行头像修改。
    */
    async function doAvatarModify(userName, index) 
    {
        // 文件大小不得超过 8 MB
        const MAX_FILE_SIZE = 8 * 1024 * 1024;
        
        // 支持的文件类型数组
        const ALLOWED_FILE_TYPES = ['image/png', 'image/jpeg', 'image/webp'];

        const avatarModifyButton = document.getElementById(`cell_${index}`);

        avatarModifyButton.addEventListener('change', 
            async (event) => 
            {
                const file          = event.target.files[0];  // 获取上传的第一个文件？
                const statusElement = document.getElementById('upload-status');

                if (!file) { return; }
                
                // 检查文件格式
                if (!ALLOWED_FILE_TYPES.includes(file.type)) 
                {
                    statusElement.textContent = '仅支持 PNG/JPED/WEBP 格式的图片。';
                    statusElement.style.color = '#F47067';

                    return;
                }
                
                // 检查文件大小
                if (file.size >= MAX_FILE_SIZE)
                {
                    statusElement.textContent = `文件大小应小于 ${MAX_FILE_SIZE / 1024 / 1024} MB!`;
                    statusElement.style.color = '#F47067';

                    return;
                }

                try 
                {
                    statusElement.textContent = '头像上传中';
                    statusElement.style.color = 'inherit';

                    const fileByteArray = new Uint8Array(await file.arrayBuffer());

                    const csrfToken  = document.querySelector('meta[name="_csrf"]').content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                    // 发送请求
                    const response 
                        = await fetch(`/api/admin/set_user_overview_avatar/${userName}`,
                        {
                            method: 'POST',
                            headers: 
                            {
                                'Content-Type': 'application/octet-stream',
                                [csrfHeader]: csrfToken
                            },
                            body: fileByteArray
                        }
                    );

                    if (!response.ok) {
                        throw new Error(await response.text());
                    }

                    statusElement.textContent = '头像更新成功！';
                    statusElement.style.color = '#57ab5a';

                    // 1.5 秒后清除状态
                    setTimeout(
                        () => { statusElement.textContent = ''; }, 1500
                    );
                }
                catch (error)
                {
                    console.error('Upload failed:', error);
                    statusElement.textContent = `上传失败: ${error.message}`;
                    statusElement.style.color = '#f47067';
                }
            }
        );
    }

    const OLDUSER_DATA = {
        "oldUserName" : null,
        "oldPassword" : null,
        "oldFullName" : null,
        "oldTelephoneNumber" : null,
        "oldEmail" : null,
        "oldRoles" : null
    };

    async function doModify(button) 
    {
        button.addEventListener(
            "click", 
            async function () 
            {
                // 向上查找离 button 最近的父级 tr 标签
                const tableRowElement = button.closest('tr');

                // 再从该 tr 标签开始向下查找所有的子级 th 和 td 标签，返回一个 NodeList
                const cells = tableRowElement.querySelectorAll('td');

                let count = parseInt(this.dataset.clockCount) || 0;
                ++count;
                this.dataset.clockCount = count;

                switch (count)
                {
                    case 1:
                        const oldCellTexts = Array.from(cells).map((cell) => cell.textContent);

                        OLDUSER_DATA.oldUserName = oldCellTexts[0];
                        OLDUSER_DATA.oldPassword = null;
                        OLDUSER_DATA.oldFullName = oldCellTexts[3];
                        OLDUSER_DATA.oldTelephoneNumber = oldCellTexts[4];
                        OLDUSER_DATA.oldEmail = oldCellTexts[5];
                        OLDUSER_DATA.oldRoles = oldCellTexts[7];

                        cells.forEach((cell, index) => 
                        {
                            switch (index)
                            {
                                case 0: // 变换成用户名输入框
                                    cell.innerHTML 
                                    = `<input type="text" id="cell_${index}" placeholder=${cell.textContent}></input>`;
                                    break;

                                case 1:
                                    cell.innerHTML  // 变换成头像修改的操作按钮
                                    = `<input type="file" id="cell_${index}"
                                              accept="image/png, image/jpeg, image/webp"
                                              onclick="doAvatarModify('${OLDUSER_DATA.oldUserName}', ${index})" hidden>
                                       <button class="gh-button" type="button" 
                                               onclick="document.getElementById('cell_${index}').click()">
                                            <span class="button-text">📌 更换头像</span>
                                       </button>
                                       <div id="upload-status"></div>`;

                                    break;
                                
                                case 6: // 注册日期（不可修改）
                                    cell.innerHTML 
                                        = `<input type="text" 
                                            id="cell_${index}"
                                            placeholder="${cell.textContent} (READ-ONLY)" readonly>
                                          </input>`;
                                    break;

                                case 7: // 变换成用户角色选项栏
                                    cell.innerHTML 
                                          = `<select id="cell_${index}">
                                                <option value="ROLE_USER">普通用户</option>
                                                <option value="ROLE_ADMIN">管理员</option>
                                                <option value="ROLE_ADMIN ROLE_USER">管理员 + 普通用户</option>
                                            </select>`;
                                
                                case 8:
                                    break;
                                
                                default:
                                    cell.innerHTML 
                                        = `<input type="text" id="cell_${index}" placeholder=${cell.textContent}></input>`;
                                    break;
                            }
                        });

                        button.innerText = "提交修改";

                        break;
                    
                    case 2:                
                        const submitData = 
                        {
                            "oldUserName"           : OLDUSER_DATA.oldUserName,
                            "newUserName"           : document.getElementById('cell_0').value || OLDUSER_DATA.oldUserName, 
                            // 如果新密码没填这一字段就为空，后端会进行相应的处理
                            "newPassword"           : document.getElementById('cell_2').value || OLDUSER_DATA.oldPassword,
                            "newFullName"           : document.getElementById('cell_3').value || OLDUSER_DATA.oldFullName,
                            "newTelephoneNumber"    : document.getElementById('cell_4').value || OLDUSER_DATA.oldTelephoneNumber,
                            "newEmail"              : document.getElementById('cell_5').value || OLDUSER_DATA.oldEmail,
                            "newRoles"              : createUserRolesJson(document.getElementById('cell_7').value) || OLDUSER_DATA.oldRoles
                        };

                        const submitDataJson = JSON.stringify(submitData);
                
                        console.info(submitDataJson);
                        
                        try 
                        {
                            // 从 meta 标签获取 CSRF Token
                            const csrfToken  = document.querySelector('meta[name="_csrf"]').content;
                            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
                            // fetch 操作....
                            const response = await fetch(
                                '/api/admin/modify_user',
                                {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type' : 'application/json',
                                        [csrfHeader]: csrfToken
                                    },
                                    body: submitDataJson
                                }
                            );

                            if (!response.ok) 
                            {
                                const errorDetail = await response.text().catch(() => null);

                                throw new Error(
                                    `Http error! statues: ${response.status}. 
                                    Detail: ${errorDetail || 'Unknown'}`
                                );
                            }
                            else 
                            {
                                const successText = await response.text().catch(() => null);
                                alert(successText);
                            }

                        }
                        catch(error) 
                        {
                            console.error(error);
                            alert(error);
                        }

                        location.reload();
                        this.dataset.clockCount = 0;

                        break;
                }
            }
        );
    }

    async function doDelete(button) 
    {
        // 向上查找离 button 最近的父级 tr 标签
        const tableRowElement = button.closest('tr');

        const cells = tableRowElement.querySelectorAll('td');

        let deleteUserName;

        cells.forEach((cell, index) => 
        {
                switch(index) 
                {
                    case 0:
                        deleteUserName = cell.textContent;
                        break;

                    default:
                        break;
                }
        });

        console.info(deleteUserName);

        if (confirm(`确定删除用户: ${deleteUserName} 吗？`)) 
        {
            // 从 meta 标签获取 CSRF Token
            const csrfToken  = document.querySelector('meta[name="_csrf"]').content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

            try 
            {
                const response = await fetch(
                    `/api/admin/delete/${deleteUserName}`,
                    {
                        method: 'DELETE',
                        headers: {
                            'Content-Type' : 'application/json',
                            [csrfHeader]: csrfToken
                        },
                        body: deleteUserName
                    }
                );

                if (!response.ok) 
                {
                    const errorDetail = await response.text().catch(() => null);

                    throw new Error(
                                    `Http error! statues: ${response.status}.
                                    Detail: ${errorDetail || 'Unknown'}`
                    );
                }
                else 
                {
                    const successDetail = await response.text().catch(() => null);
                    alert(successDetail);
                    location.reload();
                }

            }   
            catch(error) {
                console.error(error);
                alert(error);
            }
        }
    }

    async function doAddNewOne(button) 
    {
        button.addEventListener(
            "click",
            async function() 
            {
                const addNewUserRowElement
                    = document.getElementById('add_new_user_table_row');

                let count = parseInt(this.dataset.clockCount) || 0;
                ++count;
                this.dataset.clockCount = count;

                switch(count) 
                {
                    case 1:
                        addNewUserRowElement.innerHTML 
                            = `
                                <td data-label="ID">
                                    <input type="text" placeholder="用户 ID（自动生成）" readonly></input>
                                </td>

                                <td data-label="用户名">
                                    <input type="text" id="new_username" placeholder="新用户名"></input>
                                </td>

                                <td data-label="头像">
                                    <img src="/api/admin/get_default_avatar" alt="默认头像" 
                                    style="width: 25px; height: 25px; border-radius: 50%;"></img>
                                </td>

                                <td data-label="密码">
                                    <input type="password" id="new_password" placeholder="密码"></input>
                                </td>

                                <td data-label="全名">
                                    <input type="text" id="new_fullname" placeholder="用户全名"></input>
                                </td>

                                <td data-label="电话号码">
                                    <input type="tel" id="new_telephone" placeholder="电话号码（+86）"></input>
                                </td>

                                <td data-label="邮箱">
                                    <input type="email" id="new_email" placeholder="邮箱"></input>
                                </td>
                                
                                <td data-label="注册日期">
                                    <input type="text" id="new_register_date" placeholder="注册时间（自动生成）" readonly></input>
                                </td>

                                <td data-label="角色"> 
                                    <select id="new_roles">
                                        <option value="ROLE_USER">普通用户</option>
                                        <option value="ROLE_ADMIN">管理员</option>
                                        <option value="ROLE_ADMIN ROLE_USER">管理员 + 普通用户</option>
                                    </select>
                                </td>
                            `;
                        
                        button.innerText = '➕ 创建新用户';

                        break;
                    
                    case 2:
                        const submitData = {
                            userName        : document.getElementById('new_username').value,
                            password        : document.getElementById('new_password').value,
                            fullName        : document.getElementById('new_fullname').value,
                            telephoneNumber : document.getElementById('new_telephone').value,
                            email           : document.getElementById('new_email').value,
                            roles           : createUserRolesJson(document.getElementById('new_roles').value)
                        };

                        const submitDataJson = JSON.stringify(submitData);

                        console.info(submitDataJson);
                        
                        try 
                        {
                            // 从 meta 标签获取 CSRF Token
                            const csrfToken  = document.querySelector('meta[name="_csrf"]').content;
                            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                            const response = await fetch(
                                '/api/admin/add_new_user',
                                {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type' : 'application/json',
                                        [csrfHeader]   : csrfToken
                                    },
                                    body: submitDataJson
                                }
                            );

                            if (!response.ok) 
                            {
                                const errorDetail = await response.text().catch(() => null);

                                throw new Error(
                                    `Http error! statues: ${response.status}. 
                                    Detail: ${errorDetail || 'Unknown'}`
                                );
                            }
                            else 
                            {
                                const successDetail = await response.text().catch(() => null);
                                alert(successDetail);
                                location.reload();
                                this.dataset.clockCount = 0;
                            }
                        }
                        catch(error) {
                            console.error(error);
                            alert(error)
                        }
                        break;
                    
                    default:
                        break;
                }
            }
        );
    }

    async function doDeleteAll(button) 
    {
        button.innerText = '处理中...';
        button.disabled  = true;

        try 
        {
            if (confirm('这是一个敏感操作，确定要删除所有用户吗？')) 
            {
                // 从 meta 标签获取 CSRF Token
                const csrfToken  = document.querySelector('meta[name="_csrf"]').content;
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                const response = await fetch(
                    '/api/admin/delete/all',
                    {
                        method: 'DELETE',
                        headers: { 
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        }
                    }
                );

                if (!response.ok) 
                {
                    throw new Error(
                        `Http error: ${response.status}, 
                        Detail: ${await response.text().catch(() => null) || 'Unknow'}`
                    );
                }
                else
                {
                    alert(`${await response.text().catch(() => null)}`);
                }
            }
        }
        catch(error) 
        {
            alert(error);
            console.error(error);
        }
        finally 
        {
            button.innerText = 'ALL 🗑️';
            button.disabled  = false;
            location.reload();
        }
    }

    async function doDeleteByRange(button)
    {
        const beginInput = document.getElementById('delete_begin_id');
        const endInput   = document.getElementById('delete_end_id');

        if (beginInput.value <= 0 || endInput.value <= 0) 
        {
            alert('id 范围不得小于 0，请重新输入。');
            beginInput.value = '';
            endInput.value   = '';

            return;
        }

        button.innerText = '处理中...';
        button.disabled  = true;

        try 
        {
            // 从 meta 标签获取 CSRF Token
            const csrfToken  = document.querySelector('meta[name="_csrf"]').content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

            const response = await fetch(
                `/api/admin/delete/range/${beginInput.value}_${endInput.value}`,
                {
                    method: 'DELETE',
                    headers: {
                        [csrfHeader] : csrfToken
                    }
                }
            );

            if (!response.ok) 
            {
                throw new Error(
                    `Http error: ${response.status}, 
                    Detail: ${await response.text().catch(() => null) || 'Unknow'}`
                );
            }
            else
            {
                alert(`${await response.text().catch(() => null)}`);
            }
        }
        catch(error) 
        {
            alert(error);
            console.error(error);
        }
        finally 
        {
            button.innerText = '（Range 🗑️）批量删除';
            button.disabled = true;
            location.reload();
        }
    }
</script>
</html>