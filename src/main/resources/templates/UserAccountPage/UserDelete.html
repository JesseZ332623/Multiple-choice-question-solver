<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>用户账号信息删除</title>
</head>
<style>
    /* GitHub 暗黑主题配色 - 保持与登录页面一致 */
    :root {
        --gh-bg-color: #0D1117;
        --gh-border-color: #30363D;
        --gh-text-color: #C9D1D9;
        --gh-accent-color: #58A6FF;
        --gh-btn-danger-bg: #DA3636;
        --gh-btn-danger-hover: #F85149;
        --gh-error-color: #F85149;
    }

    body {
        background-color: var(--gh-bg-color);
        color: var(--gh-text-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        line-height: 1.5;
        margin: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .delete_form {
        background-color: #161B22;
        border: 1px solid var(--gh-border-color);
        border-radius: 6px;
        padding: 2rem;
        width: 340px;
        box-shadow: 0 8px 24px rgba(1, 4, 9, 0.5);
    }

    .delete_form-header {
        text-align: center;
        margin-bottom: 1.5rem;
    }

    .delete_form-header h1 {
        font-size: 24px;
        font-weight: 300;
        letter-spacing: -0.5px;
        margin: 0;
        color: var(--gh-error-color); /* 使用危险操作红色 */
    }

    /* 复用登录页面的表单控件样式 */
    .form-group {
        margin-bottom: 1rem;
    }

    label.required::after {
        content: "*";
        color: var(--gh-error-color);
        margin-left: 3px;
    }

    .form-control {
        background-color: #010409;
        border: 1px solid var(--gh-border-color);
        border-radius: 6px;
        color: var(--gh-text-color);
        font-size: 14px;
        padding: 5px 12px;
        width: 100%;
        box-sizing: border-box;
        height: 32px;
        margin-top: 4px;
        transition: border-color 0.2s;
    }

    .form-control:focus {
        border-color: var(--gh-accent-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3);
    }

    .form-control.invalid {
        border-color: var(--gh-error-color);
    }

    .error-message {
        color: var(--gh-error-color);
        font-size: 12px;
        margin-top: 4px;
        display: none;
    }

    /* 危险操作按钮样式 */
    button[type="button"] {
        background-color: var(--gh-btn-danger-bg);
        color: white;
        border: 1px solid rgba(218, 54, 54, 0.3);
        border-radius: 6px;
        width: 100%;
        padding: 8px 16px;
        font-weight: 500;
        cursor: pointer;
        margin-top: 1rem;
        transition: all 0.2s;
    }

    button[type="button"]:hover {
        background-color: var(--gh-btn-danger-hover);
        border-color: rgba(248, 81, 73, 0.4);
    }

    button[type="button"]:active {
        background-color: #B62424;
    }

    /* 取消提示样式 */
    #cancel {
        color: #8B949E;
        font-size: 14px;
        text-align: center;
        margin-top: 1rem;
        padding: 8px;
        border-radius: 6px;
        background-color: rgba(240, 246, 252, 0.05);
    }

    /* GitHub 风格的聚焦状态 */
    *:focus-visible {
        outline: 2px solid var(--gh-accent-color);
        outline-offset: 2px;
    }
</style>
<body>
    <div class="delete_form">
        <div class="delete_form_header">
            <h1>删除账号</h1>
        </div>

        <form id="delete_form">
            <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>

            <div class="form-group">
                <label for="user_name" class="required">用户名</label>
                <input type="text" id="user_name" class="form-control" required>
                <div class="error-message" id="usernameError"></div>
            </div>

            <div class="form-group">
                <label for="password" class="required">密码</label>
                <input type="password" id="password" class="form-control" required>
                <div class="error-message" id="passwordError"></div>
            </div>

            <button type="button" onclick="doDeleteAccount()">删除账号</button>
            <p id="cancel"></p>
        </form>
    </div>

    <script>
        // 增强版验证逻辑
        const validators = {
            user_name: value => value.length >= 3 || '用户名至少需要3个字符',
            password:  value => value.length >= 8 || '密码至少需要8个字符'
        };

        async function doDeleteAccount()
        {
            const form          = document.getElementById('delete_form');
            const errorElements = document.querySelectorAll('.error-message');

            errorElements.forEach(e => { e.style.display = 'none'; });

            let isValid = true;

            for (const [id, validator] of Object.entries(validators))
            {
                const input     = document.getElementById(id);
                const errorEl   = document.getElementById(`${id}Error`);
                const result    = validator(input.value.trim(), form);

                if (result !== true)
                {
                    input.classList.add('invalid');
                    errorEl.textContent = result;
                    errorEl.style.display = 'block';
                    isValid = false;
                }
                else {
                    input.classList.remove('invalid');
                }
            }

            if (!isValid) return;

            const deleteAccountData = {
                userName : document.getElementById('user_name').value,
                password : document.getElementById('password').value
            };

            const deleteAccountDataJson = JSON.stringify(deleteAccountData);

            console.info(deleteAccountDataJson);

            if (!confirm(`用户：${deleteAccountData.userName}，这是一次敏感操作，确定要删除账户吗？`)) 
            {
                const cancelDisplay 
                    = document.getElementById('cancel');

                cancelDisplay.innerText = '很高兴你能够留下来！';

                return;
            }

            try
            {
                // 从 meta 标签获取 CSRF Token
                const csrfToken  = document.querySelector('meta[name="_csrf"]').content;
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                const response = await fetch(
                    '/api/user_info/delete',
                    {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        },
                        body: deleteAccountDataJson
                    }
                );

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(errorData || '无法删除账户')
                }

                alert(`删除账户成功！再会，用户：${deleteAccountData.userName}！`);

                // 重置表单
                document.querySelectorAll('input')
                        .forEach(input => input.value = '');

                window.location = '/user_info/login';

            }
            catch (error)
            {
                alert('登录失败：' + error.message);
                console.error(error);

                // 重置表单
                document.querySelectorAll('input')
                        .forEach(input => input.value = '');
            }
        }
    </script>
</body>
</html>