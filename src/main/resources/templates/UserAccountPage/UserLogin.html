<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>用户登录</title>
</head>

<style>
    /* GitHub 暗黑主题配色 */
    :root {
        --gh-bg-color: #0D1117;
        --gh-border-color: #30363D;
        --gh-text-color: #C9D1D9;
        --gh-accent-color: #58A6FF;
        --gh-btn-bg: #238636;
        --gh-btn-hover: #2EA043;
        --gh-error-color: #F85149;
    }

    body {
        background-color: var(--gh-bg-color);
        color: var(--gh-text-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        line-height: 1.5;
        margin: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .login-form {
        background-color: #161B22;
        border: 1px solid var(--gh-border-color);
        border-radius: 6px;
        padding: 2rem;
        width: 340px;
        box-shadow: 0 8px 24px rgba(1, 4, 9, 0.5);
    }

    .login-form-header {
        text-align: center;
        margin-bottom: 1.5rem;
    }

    .login-form-header h1 {
        font-size: 24px;
        font-weight: 300;
        letter-spacing: -0.5px;
        margin: 0;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    label.required::after {
        content: "*";
        color: var(--gh-error-color);
        margin-left: 3px;
    }

    .form-control {
        background-color: #010409;
        border: 1px solid var(--gh-border-color);
        border-radius: 6px;
        color: var(--gh-text-color);
        font-size: 14px;
        padding: 5px 12px;
        width: 100%;
        box-sizing: border-box;
        height: 32px;
        margin-top: 4px;
        transition: border-color 0.2s;
    }

    .form-control:focus {
        border-color: var(--gh-accent-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(46, 160, 67, 0.3);
    }

    .form-control.invalid {
        border-color: var(--gh-error-color);
    }

    .error-message {
        color: var(--gh-error-color);
        font-size: 12px;
        margin-top: 4px;
        min-height: 18px;
        display: none;
    }

    .btn {
        background-color: var(--gh-btn-bg);
        color: white;
        border: 1px solid rgba(240, 246, 252, 0.1);
        border-radius: 6px;
        width: 100%;
        padding: 8px 16px;
        font-weight: 500;
        cursor: pointer;
        margin-top: 1rem;
        transition: background-color 0.2s;
    }

    .btn:hover {
        background-color: var(--gh-btn-hover);
        border-color: #3FB950;
    }

    .btn:active {
        background-color: #238636;
        transition: none;
    }

    /* GitHub 风格的聚焦状态 */
    *:focus-visible {
        outline: 2px solid var(--gh-accent-color);
        outline-offset: 2px;
    }

    /* 新增链接样式 */
    a {
        color: var(--gh-accent-color);
        text-decoration: none;
        font-size: 14px;
        transition: color 0.2s ease, text-decoration 0.2s ease;
        display: block;
        margin: 1rem 0;
        position: relative;
    }

    a:hover {
        color: #79C0FF; /* GitHub 悬停蓝 */
        text-decoration: underline;
        text-decoration-thickness: 1.5px;
    }

    a:focus-visible {
        outline: 2px solid var(--gh-accent-color);
        outline-offset: 2px;
        border-radius: 3px;
    }

    /* 微调原有表单间距 */
    .login-form-body {
        display: flex;
        flex-direction: column;
    }

    /* 新增发送验证码按钮样式 */
    #send_verify_code {
        background-color: var(--gh-btn-bg);
        color: white;
        border: 1px solid rgba(240, 246, 252, 0.1);
        border-radius: 5px;
        padding: 6px 12px;
        font-size: 14px;
        margin-top: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    #send_verify_code:hover {
        background-color: var(--gh-btn-hover);
        border-color: rgba(240, 246, 252, 0.3);
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(1, 4, 9, 0.5);
        transition: 
          background-color 0.2s ease,
          border-color 0.2s ease,
          transform 0.2s cubic-bezier(0.3, 0.9, 0.5, 1.5),
          box-shadow 0.2s ease;
      }
      
      #send_verify_code:active {
        transform: translateY(0);
        box-shadow: 0 1px 4px rgba(1, 4, 9, 0.3);
        transition: none;
      }

    #send_verify_code:disabled {
        background-color: #555;
        cursor: not-all-allowed;
    }
</style>

<body>
    <div class="login-form">
        <div class="login-form-header">
            <h1>登录</h1>
        </div>
        
        <form class="login-form-body" id="loginForm">
            <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
            <div class="form-group">
                <label for="user_name" class="required">用户名</label>
                <input type="text" id="user_name" name="username" class="form-control" required>
                <div class="error-message" id="user_nameError"></div>
            </div>

            <div class="form-group">
                <label for="password" class="required">密码</label>
                <input type="password" id="password" name="username" class="form-control" required>
                <div class="error-message" id="passwordError"></div>
            </div>
            
            <!-- 验证码发送与校验区域，用户无需显式的填写邮箱，后端会查询出来的 -->
            <div class="form-group">
                <label for="verify_code">验证码</label>
                <input type="text" id="verify_code" class="form-control" pattern="\d*" required>
                <button id="send_verify_code" onclick="doObtainVarifyCode()">
                    获取验证码
                </button>
                <div class="notify-message" id="notifyMessage"></div>
                <div class="error-message" id="verify_codeError"></div>
            </div>

            <a href="/user_info/register">还没账户？先去注册一个吧！</a>

            <button type="button" class="btn" onclick="doLogin()">用户登录</button>
        </form>
    </div>

    <script>
        // 增强版验证逻辑
        const validators = {
            user_name: value => value.length >= 3 || '用户名至少需要3个字符',
            password:  value => value.length >= 8 || '密码至少需要8个字符',
            verify_code : value => value.length >= 0 || '验证码不得为空'
        };
        
        function showError(elementId, message)
        {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.style.display = 'block';
        }
          
        function showNotify(message) 
        {
            const el = document.getElementById('notifyMessage');
            el.textContent = message;
            el.style.color = `#58A6FF`;
        }

        async function doObtainVarifyCode()
        {
            // 每次调用前，先清空错误和通知的内容。
            document.getElementById('verify_codeError').textContent = '';
            document.getElementById('notifyMessage').textContent    = '';

            // 从 meta 标签获取 CSRF Token
            const csrfToken  = document.querySelector('meta[name="_csrf"]').content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
            
            // 从表单中拿到用户名
            let userName  = document.getElementById('user_name').value.trim();
            const sendBtn = document.getElementById('send_verify_code');

            if (!userName) {
                showError('user_nameError', "请先输入用户名!");
                return;
            }

            sendBtn.disabled = true;

            try 
            {
                const response = await fetch(
                    `/api/email/send_verify_code_email/${userName}`,
                    {
                        method: 'POST',
                        headers: { [csrfHeader]: csrfToken }
                    }
                );

                if (!response.ok) 
                {
                    sendBtn.disabled = false;
                    throw new Error(
                        `验证码发送失败，状态码：${response.status}\n原因：${await response.text()}。`
                    );
                }

                showNotify('验证码已经发送至您的邮箱。');
                setTimeout(() => sendBtn.disabled = false, 90000);
            }
            catch (error)
            {
                showError('verify_codeError', error.message);
            }
        }

        async function doLogin() 
        {
            const form          = document.getElementById('loginForm');
            const errorElements = document.querySelectorAll('.error-message');

            errorElements.forEach(e => { e.style.display = 'none'; });

            let isValid = true;

            for (const [id, validator] of Object.entries(validators)) 
            {
                const input     = document.getElementById(id);
                const errorEl   = document.getElementById(`${id}Error`);
                
                if (!input.value)
                {
                    input.classList.add('invalid');
                    errorEl.textContent = result;
                    errorEl.style.display = 'block';
                    isValid = false;
                }

                const result = validator(input.value.trim(), form);
                
                if (result !== true) 
                {
                    input.classList.add('invalid');
                    errorEl.textContent = result;
                    errorEl.style.display = 'block';
                    isValid = false;
                } 
                else 
                {
                    input.classList.remove('invalid');
                }
            }

            if (!isValid) { return; }

            const loginData = 
            {
                userName   : document.getElementById('user_name').value,
                password   : document.getElementById('password').value,
                verifyCode : document.getElementById('verify_code').value
            };

            const loginDataJson = JSON.stringify(loginData);

            console.info(loginDataJson);

            try
            {
                // 从 meta 标签获取 CSRF Token
                const csrfToken  = document.querySelector('meta[name="_csrf"]').content;
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                const response = await fetch(
                    '/api/user_info/login',
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        },
                        body: loginDataJson
                        //credentials: 'include'
                    }
                );

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(errorData || '登录失败');
                }

                alert(`登录成功，欢迎用户：${loginData.userName}！`);

                // 重置表单
                document.querySelectorAll('input')
                        .forEach(input => input.value = '');

                window.location.href = '/user_info/user_front_page';                
            }
            catch (error) 
            {
                alert('登录失败：' + error.message);
                console.error(error);

                // 重置表单
                document.querySelectorAll('input')
                        .forEach(input => input.value = '');
            }
        }
    </script>
</body>

</html>