<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>用户账号信息修改</title>
</head>
<style>
    /* GitHub 暗黑主题核心变量 */
    :root {
        --gh-bg-color: #0D1117;
        --gh-border-color: #30363D;
        --gh-text-color: #C9D1D9;
        --gh-accent-color: #58A6FF;
        --gh-btn-bg: #238636;
        --gh-btn-hover: #2EA043;
        --gh-error-color: #F85149;
    }

    body {
        background-color: var(--gh-bg-color);
        color: var(--gh-text-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        line-height: 1.5;
        margin: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .auth-form {
        background-color: #161B22;
        border: 1px solid var(--gh-border-color);
        border-radius: 6px;
        padding: 2rem;
        width: 400px;
        box-shadow: 0 8px 24px rgba(1, 4, 9, 0.5);
    }

    .auth-form-header {
        text-align: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid var(--gh-border-color);
        padding-bottom: 1rem;
    }

    .auth-form-header h1 {
        font-size: 24px;
        font-weight: 300;
        letter-spacing: -0.5px;
        margin: 0;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    label.required::after {
        content: "*";
        color: var(--gh-error-color);
        margin-left: 3px;
    }

    .form-control {
        background-color: #010409;
        border: 1px solid var(--gh-border-color);
        border-radius: 6px;
        color: var(--gh-text-color);
        font-size: 14px;
        padding: 5px 12px;
        width: 100%;
        box-sizing: border-box;
        height: 32px;
        margin-top: 4px;
        transition: border-color 0.2s;
    }

    .form-control:focus {
        border-color: var(--gh-accent-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(46, 160, 67, 0.3);
    }

    .form-control.invalid {
        border-color: var(--gh-error-color);
    }

    .error-message {
        color: var(--gh-error-color);
        font-size: 12px;
        margin-top: 4px;
        display: none;
    }

    .btn {
        background-color: var(--gh-btn-bg);
        color: white;
        border: 1px solid rgba(240, 246, 252, 0.1);
        border-radius: 6px;
        width: 100%;
        padding: 8px 16px;
        font-weight: 500;
        cursor: pointer;
        margin-top: 1.5rem;
        transition: background-color 0.2s;
    }

    .btn:hover {
        background-color: var(--gh-btn-hover);
        border-color: #3FB950;
    }

    /* 适配长表单的滚动 */
    .auth-form-body {
        max-height: 70vh;
        overflow-y: auto;
        padding-right: 8px;
    }

    /* 滚动条样式 */
    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #161B22;
    }

    ::-webkit-scrollbar-thumb {
        background: #30363D;
        border-radius: 4px;
    }
</style>
<body>
    <div class="auth-form">
        <div class="auth-form-header">
            <h1>修改您的账号信息</h1>
        </div>
        
        <form class="auth-form-body" id="modifyForm">
            <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
            <div class="form-group">
                <label for="old_user_name" class="required">旧用户名</label>
                <input type="text" id="old_user_name" 
                       class="form-control" placeholder="您的旧用户名" required>
                <div class="error-message" id="usernameError"></div>
            </div>
            <div class="form-group">
                <label for="new_user_name" class="required">新用户名</label>
                <input type="text" id="new_user_name" 
                       class="form-control" placeholder="您的新用户名" required>
                <div class="error-message" id="usernameError"></div>
            </div>
            
            <div class="form-group">
                <label for="old_password" class="required">旧密码</label>
                <input type="password" id="old_password" 
                       class="form-control" placeholder="您的旧密码" required>
                <div class="error-message" id="passwordError"></div>
            </div>
            <div class="form-group">
                <label for="new_password" class="required">新密码</label>
                <input type="password" id="new_password" 
                       class="form-control" placeholder="您的新密码" required>
                <div class="error-message" id="passwordError"></div>
            </div>

            <div class="form-group">
                <label for="confirm_password" class="required">确认新密码</label>
                <input type="password" id="confirm_password" 
                       class="form-control" placeholder="确认您的新密码" required>
                <div class="error-message" id="confirmPasswordError"></div>
            </div>

            <div class="form-group">
                <label for="email" class="required">新邮箱</label>
                <input type="email" id="email" class="form-control" placeholder="您的新邮箱" required>
                <div class="error-message" id="emailError"></div>
            </div>

            <div class="form-group">
                <label for="full_name">全名</label>
                <input type="text" id="full_name" 
                       class="form-control" placeholder="您的全名">
            </div>

            <div class="form-group">
                <label for="phone_number">手机号</label>
                <input type="tel" id="phone_number" 
                       class="form-control" placeholder="您的新手机号">
            </div>

            <button type="button" class="btn" onclick="doModify()">
                提交修改
            </button>
        </form>
    </div>

    <script>
        const validators = 
        {
            old_user_name : value => value.length >= 3 || '用户名至少需要3个字符',
            new_user_name : value => value.length >= 3 || '用户名至少需要3个字符',
            old_password  : value => value.length >= 8 || '密码至少需要8个字符',
            new_password  : value => value.length >= 8 || '密码至少需要8个字符',
            confirm_password : (value, form) => 
            value === document.getElementById('new_password').value || 
                      '两次输入的密码不一致',
            email: value => 
                /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value) || '请输入有效的邮箱地址'
        };


        async function doModify() 
        {
            const form = document.getElementById('modifyForm');
            const errorElements = document.querySelectorAll('.error-message');
            errorElements.forEach(el => el.style.display = 'none');
            
            let isValid = true;

            // 实时验证
            for (const [id, validator] of Object.entries(validators)) 
            {
                const input     = document.getElementById(id);
                const errorEl   = document.getElementById(`${id}Error`);
                const result    = validator(input.value.trim(), form);
                
                if (result !== true) 
                {
                    input.classList.add('invalid');
                    errorEl.textContent = result;
                    errorEl.style.display = 'block';
                    isValid = false;
                } 
                else 
                {
                    input.classList.remove('invalid');
                }
            }

            if (!isValid) return;

            const submitData = 
            {
                userLoginDTO : {
                    userName : document.getElementById('old_user_name').value,
                    password : document.getElementById('old_password').value
                },
                userMidifyInfoDTO : {
                    newUserName : document.getElementById('new_user_name').value,
                    newPassword : document.getElementById('new_password').value,
                    newFullName : document.getElementById('full_name').value,
                    newTelephoneNumber : document.getElementById('phone_number').value,
                    newEmail : document.getElementById('email').value
                }
            };

            const submitDataJson = JSON.stringify(submitData);

            console.info(submitDataJson);

            try 
            {
                // 从 meta 标签获取 CSRF Token
                const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                const response = await fetch(
                    '/api/user_info/modify',
                    {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        },
                        body: submitDataJson
                    }
                );
    
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(errorData || '修改失败');
                }
    
                alert(`修改成功，欢迎用户：${submitData.userMidifyInfoDTO.newUserName}！`);
    
                // 重置表单
                document.querySelectorAll('input')
                        .forEach(input => input.value = '');

                window.location = '/user_info/login';
            }
            catch (error)
            {
                alert('注册失败：' + error.message);
                console.error(error);

                // 重置表单
                document.querySelectorAll('input')
                        .forEach(input => input.value = '');
            }
        }
    </script>
</body>
</html>