<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title th:text="${UserOverview.getUserName()} + ' çš„ä¸»é¡µ'"></title>
</head>
<style>
    :root {
        --gh-bg: #1f2428;
        --gh-border: #444c56;
        --gh-text: #adbac7;
        --gh-text-secondary: #768390;
        --gh-avatar-border: rgba(99, 110, 123, 0.4);
    }

    body {
        background-color: var(--gh-bg);
        color: var(--gh-text);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        line-height: 1.5;
        margin: 2rem;
        max-width: 768px;
        margin: 2rem auto;
    }

    h1 {
        color: #ffffff;
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--gh-border);
    }

    #user_overview {
        background-color: #2d333b;
        border: 1px solid var(--gh-border);
        border-radius: 6px;
        padding: 2rem;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    #user_overview img {
        width: 128px;
        height: 128px;
        border-radius: 50%;
        border: 3px solid var(--gh-avatar-border);
        margin-bottom: 1.5rem;
        display: block;
    }

    #user_overview p {
        margin: 0.8rem 0;
        font-size: 14px;
        display: flex;
        align-items: baseline;
    }

    #user_overview p::before {
        content: attr(data-label);
        color: var(--gh-text-secondary);
        min-width: 100px;
        margin-right: 1rem;
        font-size: 0.9em;
    }

    #user_overview a {
        width: 110px;
        margin: 0.8rem 0;
        font-size: 14px;
        display: flex;
        text-decoration: none;
        background-color: #373e47;
        color: #adbac7;
        border: 1px solid #444c56;
        border-radius: 6px;
        padding: 5px 8px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.3, 0, 0.5, 1);
        margin-top: 1rem;
        
    }

    #user_overview a:hover {
        background-color: #1f6feb;
    }

    #user_overview a:active {
        transform: scale(0.95);  /* ç¼©å°åˆ° 95% */
        background-color: #1f6feb; /* GitHub è“è‰² */
        border-color: #1f6feb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
    }

    /* ä¸ºæ¯ä¸ªä¿¡æ¯é¡¹æ·»åŠ æ•°æ®æ ‡ç­¾ */
    p:nth-child(2)::before { content: "ç”¨æˆ· IDï¼š"; }
    p:nth-child(3)::before { content: "ç”¨æˆ·åï¼š"; }
    p:nth-child(4)::before { content: "å…¨åï¼š"; }
    p:nth-child(5)::before { content: "ç”µè¯ï¼š"; }
    p:nth-child(6)::before { content: "é‚®ç®±ï¼š"; }
    p:nth-child(7)::before { content: "æ³¨å†Œæ—¶é—´ï¼š"; }
    p:nth-child(8)::before { content: "è§’è‰²ï¼š"; }

    /* ç‰¹æ®Šæ ·å¼è°ƒæ•´ */
    #user_overview p:nth-child(8) {
        color: #57ab5a; /* GitHub æƒé™é¢œè‰² */
        font-weight: 500;
    }

    /* GitHub é£æ ¼æŒ‰é’® */
    .gh-button{
        background-color: #373e47;
        color: #adbac7;
        border: 1px solid #444c56;
        border-radius: 6px;
        padding: 5px 16px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 80ms ease-out;
        margin-top: 1rem;
    }

    .gh-button:hover {
        background-color: #444c56;
        border-color: #768390;
    }

    .gh-button:active {
        transform: scale(0.95);  /* ç¼©å°åˆ°95% */
    }

    .avatar-upload {
        position: relative;
        margin-bottom: 2rem;
        text-align: center;
    }

    #avatar-preview {
        width: 128px;
        height: 128px;
        border-radius: 50%;
        border: 3px solid var(--gh-avatar-border);
        display: block;
        margin: 0 auto 1rem;
        object-fit: cover;
    }

    #upload-status {
        color: var(--gh-text-secondary);
        font-size: 0.9em;
        margin-top: 0.5rem;
        min-height: 1.5em;
    }

    @media (max-width: 768px) {
        body {
            margin: 1rem;
        }
        
        #user_overview {
            padding: 1.5rem;
        }
        
        #user_overview img {
            width: 96px;
            height: 96px;
            margin: 0 auto 1.5rem;
        }
    }
</style>
<body>
    <h1 th:text="${UserOverview.getUserName()} + ' çš„ä¸»é¡µ'"></h1>

    <div id="user_overview">
        <img id="avatar-image" th:src="@{'/api/user_info/user_overview_avatar/' + ${UserOverview.getUserName}}" alt="å¤´åƒ">

        <input type="file" id="avatar-input" 
               accept="image/png, image/jpeg, image/webp" 
               onclick="doAvatarModify()" hidden>
        <button class="gh-button" type="button" 
                onclick="document.getElementById('avatar-input').click()">
            <span class="button-text">ğŸ“Œ æ›´æ¢å¤´åƒ</span>
        </button>
        <div id="upload-status"></div>
        
        <p data-label="ç”¨æˆ· ID" th:text="${UserOverview.getId()}"></p>
        <p data-label="ç”¨æˆ·å" th:text="${UserOverview.getUserName()}"></p>
        <p data-label="å…¨å" th:text="${UserOverview.getFullName()}"></p>
        <p data-label="ç”µè¯" th:text="'+86 ' + ${UserOverview.getTelephoneNumber()}"></p>
        <p data-label="é‚®ç®±" th:text="${UserOverview.getEmail()}"></p>
        <p data-label="æ³¨å†Œæ—¶é—´" th:text="${UserOverview.getRegisterDateTime()}"></p>
        <p data-label="è§’è‰²" th:text="${UserOverview.getRoles()}"></p>

        <a href="/user_info/modify" id="modify-account">
            <span>âœï¸ ä¿®æ”¹è´¦æˆ·ä¿¡æ¯</span>
        </a>
    </div>
</body>

<script>
    async function doAvatarModify() 
    {
        // æ–‡ä»¶å¤§å°ä¸å¾—è¶…è¿‡ 8 MB
        const MAX_FILE_SIZE = 8 * 1024 * 1024;
        
        // æ”¯æŒçš„æ–‡ä»¶ç±»å‹
        const ALLOWED_FILE_TYPES = ['image/png', 'image/jpeg', 'image/webp'];

        const avatarModifyButton = document.getElementById('avatar-input');

        avatarModifyButton.addEventListener('change', 
            async (event) => 
            {
                const file          = event.target.files[0];  // è·å–ä¸Šä¼ çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Ÿ
                const statusElement = document.getElementById('upload-status');

                if (!file) { return; }
                
                // æ£€æŸ¥æ–‡ä»¶æ ¼å¼
                if (!ALLOWED_FILE_TYPES.includes(file.type)) 
                {
                    statusElement.textContent = 'ä»…æ”¯æŒ PNG/JPED/WEBP æ ¼å¼çš„å›¾ç‰‡ã€‚';
                    statusElement.style.color = '#F47067';

                    return;
                }
                
                // æ£€æŸ¥æ–‡ä»¶å¤§å°
                if (file.size >= MAX_FILE_SIZE)
                {
                    statusElement.textContent = `æ–‡ä»¶å¤§å°åº”å°äº ${MAX_FILE_SIZE / 1024/ 1024} MB!`;
                    statusElement.style.color = '#F47067';

                    return;
                }

                try 
                {
                    statusElement.textContent = 'å¤´åƒä¸Šä¼ ä¸­';
                    statusElement.style.color = 'inherit';

                    const fileByteArray = new Uint8Array(await file.arrayBuffer());

                    const csrfToken  = document.querySelector('meta[name="_csrf"]').content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                    // å‘é€è¯·æ±‚
                    const response 
                        = await fetch('/api/user_info/set_user_overview_avatar',
                        {
                            method: 'POST',
                            headers: 
                            {
                                'Content-Type': 'application/octet-stream',
                                [csrfHeader]: csrfToken
                            },
                            body: fileByteArray
                        }
                    );

                    if (!response.ok) {
                        throw new Error(await response.text());
                    }

                    statusElement.textContent = 'å¤´åƒæ›´æ–°æˆåŠŸï¼';
                    statusElement.style.color = '#57ab5a';

                    // 3 ç§’åæ¸…é™¤çŠ¶æ€
                    setTimeout(
                        () => { statusElement.textContent = ''; location.reload(); }, 
                        2500
                    );
                }
                catch (error) 
                {
                    console.error('Upload failed:', error);
                    statusElement.textContent = `ä¸Šä¼ å¤±è´¥: ${error.message}`;
                    statusElement.style.color = '#f47067';
                }
            }
        );
    }
</script>

</html>