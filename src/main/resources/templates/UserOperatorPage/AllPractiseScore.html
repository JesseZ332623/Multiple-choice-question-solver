<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title>练习结果查询</title>
    <style>
        :root {
            --gh-bg: #0D1117;
            --gh-border: #30363D;
            --gh-text: #C9D1D9;
            --gh-btn-bg: #238636;
            --gh-btn-hover: #2EA043;
            --gh-accent: #1F6FEB;
        }
    
        body {
            background-color: var(--gh-bg);
            color: var(--gh-text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
    
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            border: 1px solid var(--gh-border);
            border-radius: 6px;
            overflow: hidden;
            animation: tableFade 0.5s ease-in;
        }
    
        @keyframes tableFade {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    
        caption {
            font-size: 16px;
            font-weight: 600;
            padding: 12px 0;
            text-align: left;
            color: var(--gh-text);
        }
    
        th, td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid var(--gh-border);
        }
    
        th {
            background-color: #161B22;
            font-weight: 600;
        }
    
        tr:last-child td {
            border-bottom: none;
        }
    
        tr {
            background-color: var(--gh-bg);
            animation: rowEntry 0.3s ease-out both;
            animation-delay: calc(var(--i) * 0.05s);
        }
    
        @keyframes rowEntry {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
    
        #clean_record {
            background-color: var(--gh-btn-bg);
            color: white;
            border: 1px solid rgba(240, 246, 252, 0.1);
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.3, 0, 0.5, 1);
            float: right;
            margin-bottom: 15px;
        }
    
        #clean_record:hover {
            background-color: var(--gh-btn-hover);
            border-color: #8B949E;
            transform: translateY(-1px);
        }
    
        #clean_record:active {
            transform: translateY(1px);
        }
    
        #clean_record.loading {
            position: relative;
            pointer-events: none;
            padding-right: 36px;
        }
    
        #clean_record.loading::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            width: 14px;
            height: 14px;
            border-width: 2px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            transform: translate(-50%, -50%);
        }
    
        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
    
        p {
            color: #8B949E;
            font-size: 13px;
            margin-bottom: 20px;
        }

        .user-badge {
            background-color: var(#161b22);
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(#30363d);
            font-size: 14px;
            float: right;
        }
    </style>
</head>

<body>
    <div id="user_name" class="user-badge" th:text="${UserName}"></div>
    <div>
        <p th:text="'练习次数: ' + ${#lists.size(AllScoreRecord)}"></p>
    </div>
    
    <div>
        <button id="clean_record" type="button" onclick="truncateRecord(this)">
            清空练习记录
        </button>
        <table>
            <caption>练习记录</caption>
            <thead>
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">用户</th>
                    <th scope="col">练习提交时间</th>
                    <th scope="col">错误数</th>
                    <th scope="col">正确数</th>
                    <th scope="col">未答数</th>
                    <th scope="col">错误率</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="record,iter : ${AllScoreRecord}" style="--i: ${iter.index}">
                    <td th:text="${record.scoreId}"></td>
                    <td th:text="${record.userName}"></td>
                    <td th:text="${record.submitDate.toString()}"></td>
                    <td th:text="${record.errorCount}"></td>
                    <td th:text="${record.correctCount}"></td>
                    <td th:text="${record.noAnswerCount}"></td>
                    <td th:text="${record.mistakeRate} + '%'"></td>
                </tr>
            </tbody>
        </table>
    </div>
</body>

<script>
    async function truncateRecord(button) 
    {
        try 
        {
            // 从 meta 标签获取 CSRF Token
            const csrfToken  = document.querySelector('meta[name="_csrf"]').content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
            var userName     = document.getElementById('user_name').textContent;

            button.classList.add('loading');

            if (confirm('这是一个敏感操作，您确定要删除所有练习记录吗？')) 
            {
                const response = await fetch(
                    `/api/score_record/delete_by_username/${userName}`,
                    {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        }
                    }
                );

                if (!response.ok) {
                    const errorDetail = await response.text().catch(() => null);

                    throw new Error(`
                        Http error! status: ${response.status}.
                        Detail: ${errorDetail || 'Unknow'}`
                    );
                }
                else {
                    alert(
                        await response.text().catch(() => null)
                    );
                    location.reload();
                }
            }
        }
        catch (error) {
            alert(error);
            console.error(error);
        }
        finally { button.classList.remove('loading'); }
    }
</script>

</html>