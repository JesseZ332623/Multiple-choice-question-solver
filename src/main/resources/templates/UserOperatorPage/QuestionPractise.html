<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>题目练习</title>
    <style>
        body {
            background-color: #0D1117;
            /* GitHub 暗黑模式背景 */
            color: #C9D1D9;
            /* GitHub 主要文字颜色 */
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            margin: 0;
            padding: 20px;
        }

        h1 {
            color: #E6EDF3;
            /* GitHub 标题颜色 */
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        #total {
            color: #58A6FF;
            /* GitHub 强调色（蓝色） */
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 20px;
        }

        .question-container {
            background-color: #161B22;
            /* GitHub 次级背景色 */
            border-radius: 6px;
            /* GitHub 使用更小的圆角 */
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .question-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
        }

        p {
            margin: 0 0 10px 0;
            font-size: 16px;
            line-height: 1.5;
        }

        ul {
            list-style: none;
            padding: 0;
            margin: 0 0 15px 0;
        }

        li {
            margin: 10px 0;
            display: flex;
            align-items: center;
        }

        input[type="radio"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #58A6FF;
            /* GitHub 蓝色边框 */
            border-radius: 50%;
            margin-right: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        input[type="radio"]:checked {
            background-color: #58A6FF;
            /* GitHub 蓝色填充 */
            border-color: #58A6FF;
            box-shadow: inset 0 0 0 3px #161B22;
        }

        label {
            font-size: 16px;
            color: #C9D1D9;
            /* GitHub 文字颜色 */
            cursor: pointer;
        }

        label:hover {
            color: #E6EDF3;
            /* GitHub 悬停文字颜色 */
        }

        .submit-btn {
            background-color: #238636;
            /* GitHub 绿色按钮 */
            color: #FFFFFF;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .submit-btn:hover {
            background-color: #2EA043;
            /* GitHub 绿色悬停 */
        }

        .submit-btn:active {
            transform: scale(0.98);
        }

        .submit-btn:disabled {
            background-color: #30363D;
            /* GitHub 禁用背景 */
            color: #6E7681;
            /* GitHub 禁用文字 */
            cursor: not-allowed;
        }

        .feedback {
            margin-top: 10px;
            font-weight: 600;
            font-size: 14px;
        }

        .correct {
            color: #2EA043;
            /* GitHub 绿色用于正确 */
        }

        .incorrect {
            color: #F97583;
            /* GitHub 红色用于错误 */
        }

        .no_answer {
            color: #6E7681;
            /* GitHub 中性灰色 */
        }

        .total_submit_button {
            background-color: #238636;
            /* GitHub 绿色按钮 */
            color: #FFFFFF;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            margin-top: 20px;
        }

        .total_submit_button:hover {
            background-color: #2EA043;
        }

        .total_submit_button:active {
            transform: scale(0.98);
        }

        .practise_score {
            margin-top: 20px;
            padding: 15px;
            background-color: #161B22;
            /* GitHub 次级背景 */
            border-radius: 6px;
            font-size: 16px;
            line-height: 1.6;
        }

        .practise_score span {
            display: block;
        }

        .user-badge {
            background-color: var(#161b22);
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(#30363d);
            font-size: 14px;
            float: right;
        }

         /* 返回链接专项样式 */
         #return_to_frontpage {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            color: var(--gh-text);
            text-decoration: none;
            font-size: 1.1rem;
            padding: 0.8rem 1.8rem;
            border: 1px solid var(--gh-border);
            border-radius: 6px;
            background: rgba(201, 209, 217, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 0.8rem;
            backdrop-filter: blur(4px);
            z-index: 999;
        }

        #return_to_frontpage:hover {
            color: #58a6ff;
            border-color: rgba(88, 166, 255, 0.4);
            background: rgba(88, 166, 255, 0.1);
            transform: translate(-50%, -2px);
            box-shadow: 0 4px 16px rgba(88, 166, 255, 0.15);
        }

        #return_to_frontpage::before {
            content: "←";
            font-weight: 600;
            color: var(--gray);
            transition: color 0.3s ease;
        }

        #return_to_frontpage:hover::before {
            color: #58a6ff;
        }
    </style>
</head>

<body>
<div id="user_name" class="user-badge" th:text="${UserName}"></div>

<div>
    <a id="return_to_frontpage" href="/user_info/user_front_page">回首页</a>
</div>

<h1>选择题练习</h1>

<strong th:if="${#lists.size(QuestionPractise) == 0}">题库里面还没有问题呢，去添加一些吧！</strong>

<div id="total">
    <p id="total_questions" th:text="'总题数：' + ${#lists.size(QuestionPractise)}"></p>
</div>

<div th:each="question : ${QuestionPractise}" class="question-container"
     th:data-question-id="${question.questionId}" th:data-correct-answer="${question.correctAnswer}">
    <p th:text="${question.questionId} + '.' + ${question.questionContent}"></p>
    <div th:if="${question.options != null}">
        <ul>
            <li th:each="entry : ${question.options.entrySet()}">
                <input type="radio" th:id="'option_' + ${entry.getKey()}"
                       th:name="'options_' + ${question.questionId}" th:value="${entry.getKey()}">
                <span th:for="'option_' + ${entry.getKey()}" th:text="${entry.getKey()} + ': ' + ${entry.getValue()}"></span>
                <br>
            </li>
        </ul>
    </div>
    <button type="button" class="submit-btn" th:data-qid="${question.questionId}" onclick="checkAnswer(this)">
        确认
    </button>
    <div class="feedback" th:id="'feedback_' + ${question.questionId}"></div>
</div>

<div>
    <button type="button" class="total_submit_button" onclick="totalSubmit(this)">
        所有题目均已完成，交卷
    </button>
    <div class="practise_score" id="practise_score"></div>
</div>

</body>

<script>
    var TOTAL_QUESTION_AMOUNT = Number(document.getElementById("total_questions").textContent.split('：')[1]);
    var TotalCorrect = 0;
    var TotalMistake = 0;

    function checkAnswer(button) 
    {
        // 通过按钮元素向上查找父容器
        const container = button.closest('.question-container');

        // 获取用户选择的单选值
        const selected = container.querySelector('input[type="radio"]:checked')?.value;

        // 获取正确答案（假设answer字段存储的是单个字母如"A"）
        const correctAnswer = container.dataset.correctAnswer;

        // 获取反馈显示区域
        const feedback = container.querySelector('.feedback');

        if (!selected) {
            feedback.innerHTML = '<span class="incorrect">请先选择答案！</span>';
            return;
        }

        // 验证答案（不区分大小写）
        const isCorrect = selected.toUpperCase() === correctAnswer.toUpperCase();

        if (isCorrect)
        {
            updateCorrectTimes(container.dataset.questionId);

            feedback.innerHTML = '<span class="correct">✅ 回答正确！</span>';

            container.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.disabled = true;
            });

            button.disabled = true;

            ++TotalCorrect;
        }
        else 
        {
            feedback.innerHTML = `<span class="incorrect">❌ 回答错误！正确答案：${correctAnswer}</span>`;
            
            container.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.disabled = true;
            });

            button.disabled = true;
            ++TotalMistake;
        }
    }

    function getCurrentISOTimeStrWithoutZone() {
        return new Date().toISOString().split('.')[0].replace('Z', ' ');
    }

    function totalSubmit(button) 
    {
        var noAnswer    = TOTAL_QUESTION_AMOUNT - (TotalCorrect + TotalMistake);
        var mistakeRate = (TotalMistake + noAnswer) / TOTAL_QUESTION_AMOUNT * 100;

        const practiseScoreDOM = document.getElementById('practise_score');

        const recordJson = 
        {
            "userName"      : document.getElementById('user_name').textContent,
            "submitDate"    : getCurrentISOTimeStrWithoutZone(),
            "correctCount"  : TotalCorrect,
            "errorCount"    : TotalMistake,
            "noAnswerCount" : noAnswer,
            "mistakeRate"   : mistakeRate.toFixed(2)
        };

        addNewScoreRecord(recordJson, button);      // 将成绩数据写入数据表

        setTimeout(
            () => { 
                button.disabled = false;
                window.location = '../score_record/current_score_settlement'; 
            }, 2500
        );
    }

    async function updateCorrectTimes(questionId) 
    {
        try 
        {
            // 从 meta 标签获取 CSRF Token
            const csrfToken  = document.querySelector('meta[name="_csrf"]').content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

            const questionPosData = {
                "userName"   : document.getElementById('user_name').textContent,
                "questionId" : questionId
            };

            const questionPosDataJson = JSON.stringify(questionPosData);

            console.info(questionPosDataJson);

            const response = await fetch(
                `/api/redis/correct_times_plus_one`,
                { 
                    method: 'PUT', 
                    headers: {
                        'Content-Type' : 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: questionPosDataJson
                }
            );

            if (!response.ok) 
            {
                throw new Error(
                    `Http error! statues: ${response.status}
                    Error Detail: ${await response.text().catch(() => null)}`
                );
            }

            console.log(
                `Fetch api/correct_times_plus_one/${questionId} success, 
				response: ${await response.text().catch(() => null)}`
            );
        }
        catch (error) 
        {
            alert(error);
            console.error(error);
        }
    }

    async function addNewScoreRecord(recordJson, button)
    {
        try 
        {
            // 从 meta 标签获取 CSRF Token
            const csrfToken = document.querySelector('meta[name="_csrf"]').content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

            const response = await fetch(
                "/api/score_record/add_one_new_score_record",
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify(recordJson)
                }
            );

            if (!response.ok) 
            {
                const errorDetail = await response.text().catch(() => null);
                throw new Error(
                    `Http error! statues: ${response.status}. Detail: ${errorDetail?.message || 'Unknown'}`
                );
            }

            const responseText = await response.text().catch(() => null);
            
            const practiseScoreDOM = document.getElementById('practise_score');

            practiseScoreDOM.innerHTML 
                = `<span>✅ [${getCurrentISOTimeStrWithoutZone()}]: 成绩数据已提交，正在跳转至结算页面。<span>`;

            button.disabled = true;

            console.log(`${responseText}`);
        }
        catch (error) {
            console.error(error);
        }
    }
</script>
</html>